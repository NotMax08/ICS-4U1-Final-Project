import greenfoot.*;
import java.util.ArrayList;
import java.util.List;

/**
 * A display that shows the player inventory, including weapons and items
 * 
 * Images generated by Leonardo.ai
 * 
 * @author Robin, Paul, Julian & Claude
 */
public class InventoryDisplay extends Display {
    // Image variables
    private GreenfootImage openInv = new GreenfootImage("openInv.png");
    private GreenfootImage closedInv = new GreenfootImage("closedInv.png");

    private boolean isOpen = false;
    private boolean tabWasDown = false;

    private Player player;

    // Inventory utility - Now using ShopItems instead of InventoryItem helper class
    private ArrayList<ShopItems> items;
    private int[][] slotLocations; 
    private final int maxSlots = 15;
    private final int COLS = 3;
    private final int ROWS = 5;

    /**
     * Create inventory display at a fixed screen position
     * 
     * @param screenX X position on screen (not world position)
     * @param screenY Y position on screen (not world position)
     */
    public InventoryDisplay(int screenX, int screenY, Camera camera, Player player) {
        super(screenX, screenY, camera);
        this.items = new ArrayList<ShopItems>();
        this.player = player;

        closedInv = scaleImage("closedInv.png", 100, 100, 225);
        openInv = scaleImage("openInv.png", 600, 600, 242);

        // Initialize 2D coordinate map 
        createSlotMap();

        setImage(closedInv);
    }

    private void createSlotMap(){
        slotLocations = new int[15][2]; // Fixed: 15 slots, 2 coordinates each

        // Adjust these values to match where your grid starts in openInv.png
        int startX = 325; // X position of first slot
        int startY = 120;  // Y position of first slot
        int slotSpacing = 90; // Space between slot centers
        int slotsPerRow = 3;

        for (int i = 0; i < maxSlots; i++) {
            int row = i / slotsPerRow;
            int col = i % slotsPerRow;

            slotLocations[i][0] = startX + (col * slotSpacing);
            slotLocations[i][1] = startY + (row * slotSpacing);
        }
    }

    @Override
    protected void updateDisplay(){
        syncWithPlayerInventory(); // Updated logic to use ShopItems

        if(!isOpen){
            setLocation(screenX, screenY);
            setImage(closedInv);
        }else {
            setLocation(screenX + 350, screenY - 250);

            // Create image with items
            GreenfootImage canvas = new GreenfootImage(openInv);
            drawItems(canvas);
            setImage(canvas);
        }
    }

    // Draws items on the inventory
    private void drawItems(GreenfootImage img){
        for (int i = 0; i < items.size(); i++) {
            if (i >= maxSlots) break;

            ShopItems item = items.get(i);
            GreenfootImage icon = item.getImage(); 

            int x = slotLocations[i][0];
            int y = slotLocations[i][1];

            int iconX = x - (icon.getWidth() / 2);
            int iconY = y - (icon.getHeight() / 2);

            img.drawImage(icon, iconX, iconY);

            int count = 0;
            if (item instanceof StrengthPotion) {
                count = player.getItemCount(0);
            } else if (item instanceof ShieldPotion) {
                count = player.getItemCount(1);
            } else if (item instanceof ShrinkPotion) {
                count = player.getItemCount(2);
            } else if (item instanceof Key) {
                count = player.getItemCount(3); // Changed from 2 to 3
            }

            // Draw quantity text
            img.setFont(new Font("Arial", true, false, 24)); 
            img.setColor(Color.WHITE);
            img.drawString(String.valueOf(count), x + 15, y + 35);
        }
    }

    @Override
    public void act(){
        checkMouseClick();
        checkTabPress();
        updateDisplay();
    }

    private void checkMouseClick(){
        boolean mouseClickedInv = Greenfoot.mousePressed(this);
        boolean mouseIsDown = Greenfoot.mousePressed(null);

        if(!isOpen){
            if(mouseClickedInv) isOpen = true;
        }else {
            if(!mouseClickedInv && mouseIsDown) isOpen = false;
        }
    }

    private void checkTabPress(){
        boolean tabIsDown = Greenfoot.isKeyDown("tab");
        if (tabIsDown && !tabWasDown) isOpen = !isOpen;
        tabWasDown = tabIsDown;
    }

    /**
     * Logic to refresh the items list based on player inventory counts
     */
    private void syncWithPlayerInventory() {
        items.clear();

        // ID 0: Strength Potion
        if (player.getItemCount(0) > 0) {
            items.add(new StrengthPotion(true));
        }

        // ID 1: Shield Potion
        if (player.getItemCount(1) > 0) {
            items.add(new ShieldPotion(true));
        }

        // ID 2: Shrink Potion
        if (player.getItemCount(2) > 0) {
            items.add(new ShrinkPotion(true));
        }

        // ID 3: Key
        if (player.getItemCount(3) > 0) {
            items.add(new Key(true));
        }
    }

    // --- Helper methods kept for compatibility ---

    public int getItemCount() {
        return items.size();
    }

    public boolean isFull() {
        return items.size() >= maxSlots;
    }

    public void clear() {
        items.clear();
    }
}